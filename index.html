<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Budget Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JS (v2) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

  <style>
    :root {
      --bg-color: rgba(13, 23, 30, 1);
      --panel-bg: #111c24;
      --accent: #36cfc9;
      --accent-muted: #234856;
      --text-main: #f5f5f5;
      --text-muted: #a0adb8;
      --danger: #ff4d4f;
      --border-color: #283540;
      --pill-radius: 999px;
      --font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-family);
      background: var(--bg-color);
      color: var(--text-main);
    }

    a {
      color: var(--accent);
    }

    input,
    button,
    select {
      font-family: inherit;
    }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Top bar */

    .top-bar {
      height: 64px;
      background: #0a141a;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      background: #1a2a33;
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .top-right-auth {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--accent-muted);
      color: var(--text-main);
      transition: background 0.15s ease, border-color 0.15s ease,
        color 0.15s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: #041016;
    }

    .btn-outline {
      background: transparent;
      border-color: var(--accent-muted);
      color: var(--text-muted);
    }

    .btn-danger {
      background: transparent;
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn:hover {
      filter: brightness(1.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Layout */

    .content {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app-container {
      max-width: 1100px;
      width: 100%;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .app-container {
        grid-template-columns: 1fr;
      }
    }

    /* Auth panel */

    .auth-wrapper {
      width: 100%;
      max-width: 420px;
      margin: 32px auto;
      background: var(--panel-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 24px 20px 20px;
    }

    .auth-header {
      margin-bottom: 16px;
    }

    .auth-header h2 {
      margin: 0 0 4px;
      font-size: 20px;
    }

    .auth-header p {
      margin: 0;
      font-size: 13px;
      color: var(--text-muted);
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .field input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: #071018;
      color: var(--text-main);
      font-size: 14px;
    }

    .field input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .auth-footer {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .auth-error {
      font-size: 12px;
      color: var(--danger);
      margin-bottom: 4px;
      min-height: 16px;
    }

    /* Calendar panel */

    .card {
      background: var(--panel-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      min-height: 420px;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .calendar-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 120px;
      justify-content: flex-start;
    }

    .calendar-nav.right {
      justify-content: flex-end;
    }

    .calendar-month-label {
      flex: 1;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.04em;
      font-size: 15px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 12px;
    }

    .calendar-weekday {
      text-align: center;
      padding: 4px;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .calendar-day {
      border-radius: 8px;
      border: 1px solid transparent;
      padding: 4px;
      min-height: 70px;
      cursor: pointer;
      position: relative;
      background: #0b151d;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .calendar-day.out-of-range {
      opacity: 0.25;
      pointer-events: none;
    }

    .calendar-day.disabled-range {
      opacity: 0.3;
      cursor: default;
      pointer-events: none;
    }

    .calendar-day.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(54, 207, 201, 0.3);
    }

    .calendar-day-number {
      font-size: 12px;
      color: var(--text-muted);
    }

    .calendar-day-number.today {
      color: var(--accent);
      font-weight: 600;
    }

    .pill-compact {
      border-radius: 999px;
      padding: 2px 6px;
      font-size: 10px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #041016;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.45);
    }

    .day-total {
      position: absolute;
      bottom: 4px;
      right: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Detail / summary panel */

    .summary-header {
      margin-bottom: 8px;
    }

    .summary-header h2 {
      margin: 0;
      font-size: 16px;
    }

    .summary-header p {
      margin: 0;
      font-size: 12px;
      color: var(--text-muted);
    }

    .limit-row {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }

    .limit-row span strong {
      color: var(--text-main);
    }

    .limit-highlight {
      color: var(--accent);
    }

    .limit-over {
      color: var(--danger);
    }

    .event-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .event-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--pill-radius);
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      background: #1d2e37;
      color: #041016;
      border: 1px solid rgba(0, 0, 0, 0.15);
    }

    .event-pill .event-name {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 160px;
      color: #041016;
    }

    .event-pill.done .event-name {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .event-pill .event-value {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .event-pill .event-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pill-checkbox {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(0, 0, 0, 0.35);
      background: rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #041016;
      flex-shrink: 0;
    }

    /* Add / edit form */

    .add-form {
      margin-top: 10px;
      border-top: 1px solid var(--border-color);
      padding-top: 8px;
    }

    .add-form-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
    }

    @media (max-width: 500px) {
      .add-form-row {
        grid-template-columns: 1.4fr 1fr;
        grid-auto-rows: auto;
        grid-auto-flow: row;
      }
    }

    .add-form input[type="text"],
    .add-form input[type="number"],
    .add-form input[type="color"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: #071018;
      color: var(--text-main);
      font-size: 12px;
    }

    .add-form input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .add-form label {
      display: block;
      font-size: 11px;
      margin-bottom: 2px;
      color: var(--text-muted);
    }

    .add-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 12px;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 380px;
      background: #081219;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 14px 14px 12px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 15px;
    }

    .modal-close {
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: var(--text-muted);
    }

    .modal-body {
      font-size: 13px;
    }

    .modal-row {
      margin-bottom: 8px;
    }

    .modal-row label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .modal-row input[type="text"],
    .modal-row input[type="number"],
    .modal-row input[type="color"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: #071018;
      color: var(--text-main);
      font-size: 13px;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .modal-footer-left {
      display: flex;
      gap: 6px;
    }

    .modal-footer-right {
      display: flex;
      gap: 6px;
    }

    .modal-error {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
      margin-top: 2px;
    }

    .empty-state {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="top-bar">
      <div class="top-left">
        <!-- logo.png must be in repo root -->
        <img src="logo.png" alt="Logo" class="logo" />
        <div class="app-title">Budget Calendar</div>
      </div>
      <div class="top-right-auth" id="topAuthStatus"></div>
    </header>

    <main class="content">
      <!-- Auth view -->
      <div id="authView" class="auth-wrapper" style="display:none;">
        <div class="auth-header">
          <h2>Sign in</h2>
          <p>Use your Supabase email/password user to access the shared calendar.</p>
        </div>
        <div class="auth-error" id="authError"></div>
        <div class="field">
          <label for="authEmail">Email</label>
          <input type="email" id="authEmail" autocomplete="email" />
        </div>
        <div class="field">
          <label for="authPassword">Password</label>
          <input type="password" id="authPassword" autocomplete="current-password" />
        </div>
        <div class="field">
          <button class="btn btn-primary" id="loginButton">Sign in</button>
        </div>
        <div class="auth-footer">
          <span>Users are managed in Supabase.</span>
        </div>
      </div>

      <!-- App view -->
      <div id="appView" class="app-container" style="display:none;">
        <!-- Calendar -->
        <section class="card">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="btn btn-outline" id="prevMonthBtn">&lt;</button>
            </div>
            <div class="calendar-month-label" id="monthLabel">Month</div>
            <div class="calendar-nav right">
              <button class="btn btn-outline" id="nextMonthBtn">&gt;</button>
            </div>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- weekdays row -->
          </div>
        </section>

        <!-- Detail / summary -->
        <section class="card">
          <div class="summary-header">
            <h2 id="summaryTitle">Day summary</h2>
            <p id="summarySubtitle">Select a day to view details.</p>
          </div>

          <div class="limit-row">
            <span>
              Total used:
              <strong id="usedAmount">0</strong>
            </span>
            <span>
              Remaining:
              <strong id="remainingAmount" class="limit-highlight">0</strong>
            </span>
          </div>
          <div class="limit-row">
            <span>
              Daily limit:
              <strong id="limitAmount">0</strong>
            </span>
            <span id="overFlag" class="limit-over"></span>
          </div>

          <div class="event-list" id="eventList"></div>

          <div class="empty-state" id="emptyState" style="display:none;">
            No events for this day yet.
          </div>

          <div class="add-form">
            <div class="add-form-row">
              <div>
                <label for="newName">Name</label>
                <input type="text" id="newName" placeholder="Event name" />
              </div>
              <div>
                <label for="newValue">Value</label>
                <input type="number" id="newValue" placeholder="0" min="0" step="0.01" />
              </div>
              <div>
                <label for="newColor">Color</label>
                <input type="color" id="newColor" value="#36cfc9" />
              </div>
            </div>
            <div class="add-form-actions">
              <button class="btn btn-primary" id="addEventBtn">Add event</button>
            </div>
            <div class="hint">
              Everyone who can log in can see and edit all events.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Edit modal -->
  <div class="modal-backdrop" id="editModalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit event</h3>
        <span class="modal-close" id="editModalClose">&times;</span>
      </div>
      <div class="modal-body">
        <div class="modal-row">
          <label for="editName">Name</label>
          <input type="text" id="editName" />
        </div>
        <div class="modal-row">
          <label for="editValue">Value</label>
          <input type="number" id="editValue" min="0" step="0.01" />
        </div>
        <div class="modal-row">
          <label for="editColor">Color (applies to all with same name)</label>
          <input type="color" id="editColor" />
        </div>
        <div class="modal-error" id="editError"></div>
        <div class="modal-footer">
          <div class="modal-footer-left">
            <button class="btn btn-danger" id="deleteEventBtn">Delete</button>
          </div>
          <div class="modal-footer-right">
            <button class="btn btn-outline" id="editCancelBtn">Cancel</button>
            <button class="btn btn-primary" id="editSaveBtn">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /******** CONFIG ********/

    // TODO: Replace with your Supabase credentials
    const SUPABASE_URL = "https://tecbuwpdhhlbzgjadego.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_DDNV8FDFpgYoEelsTk0zbQ_AL7oePju";

    // Daily limit (easy to change)
    const DAILY_LIMIT = 6000000;

    /******** SUPABASE CLIENT ********/

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    /******** STATE ********/

    const WEEKDAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const MONTH_NAMES = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December"
    ];

    // Limit range: from 2025-12-01 to 2026-12-31
    const RANGE_START = new Date(2025, 11, 1); // 0-based month, 11 = December
    const RANGE_END = new Date(2026, 11, 31);

    let currentMonth = new Date(2025, 11, 1); // start at Dec 2025
    let selectedDate = new Date(2025, 11, 1); // selected day
    let eventsByDate = {}; // key: 'YYYY-MM-DD' -> array of events
    let currentUser = null;

    // For edit modal
    let editingEvent = null;

    /******** DOM HELPERS ********/

    const $ = (id) => document.getElementById(id);

    /******** AUTH ********/

    async function checkSession() {
      const {
        data: { session }
      } = await supabase.auth.getSession();
      currentUser = session ? session.user : null;
      updateAuthUI();
      if (currentUser) {
        await refreshEventsForMonth();
      }
    }

    function updateAuthUI() {
      const authView = $("authView");
      const appView = $("appView");
      const topAuthStatus = $("topAuthStatus");

      if (currentUser) {
        authView.style.display = "none";
        appView.style.display = "grid";

        topAuthStatus.innerHTML = `
          <span>Signed in</span>
          <button class="btn btn-outline" id="logoutButton">Sign out</button>
        `;
        $("logoutButton").onclick = logout;
      } else {
        authView.style.display = "block";
        appView.style.display = "none";

        topAuthStatus.innerHTML = `
          <span>Not signed in</span>
        `;
      }
    }

    async function login() {
      const email = $("authEmail").value.trim();
      const password = $("authPassword").value;
      $("authError").textContent = "";

      if (!email || !password) {
        $("authError").textContent = "Email and password are required.";
        return;
      }

      $("loginButton").disabled = true;

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      $("loginButton").disabled = false;

      if (error) {
        $("authError").textContent = error.message;
        return;
      }

      currentUser = data.user;
      updateAuthUI();
      await refreshEventsForMonth();
    }

    async function logout() {
      await supabase.auth.signOut();
      currentUser = null;
      eventsByDate = {};
      updateAuthUI();
    }

    /******** DATE UTIL ********/

    function formatDateKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function parseDateKey(key) {
      const [y, m, d] = key.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function datesEqual(d1, d2) {
      return (
        d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate()
      );
    }

    function isInRange(date) {
      return date >= RANGE_START && date <= RANGE_END;
    }

    /******** CALENDAR RENDERING ********/

    function renderCalendar() {
      const grid = $("calendarGrid");
      grid.innerHTML = "";

      // Weekday headers
      for (const w of WEEKDAYS) {
        const div = document.createElement("div");
        div.className = "calendar-weekday";
        div.textContent = w;
        grid.appendChild(div);
      }

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      $("monthLabel").textContent = `${MONTH_NAMES[month]} ${year}`;

      const firstOfMonth = new Date(year, month, 1);
      const firstWeekday = firstOfMonth.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const prevMonth = new Date(year, month - 1, 1);
      const daysInPrevMonth = new Date(
        prevMonth.getFullYear(),
        prevMonth.getMonth() + 1,
        0
      ).getDate();

      const today = new Date();

      // leading days from previous month
      for (let i = 0; i < firstWeekday; i++) {
        const dayNum = daysInPrevMonth - firstWeekday + 1 + i;
        const date = new Date(year, month - 1, dayNum);
        const dayCell = buildDayCell(date, true, today);
        grid.appendChild(dayCell);
      }

      // current month days
      for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dayCell = buildDayCell(date, false, today);
        grid.appendChild(dayCell);
      }

      // trailing days to complete weeks
      const totalCells = firstWeekday + daysInMonth;
      const trailing = (7 - (totalCells % 7)) % 7;
      for (let i = 1; i <= trailing; i++) {
        const date = new Date(year, month + 1, i);
        const dayCell = buildDayCell(date, true, today);
        grid.appendChild(dayCell);
      }

      updateMonthNavButtons();
    }

    function buildDayCell(date, isOtherMonth, today) {
      const div = document.createElement("div");
      div.className = "calendar-day";

      if (isOtherMonth) {
        div.classList.add("out-of-range");
      }

      if (!isInRange(date)) {
        div.classList.add("disabled-range");
      }

      if (datesEqual(date, selectedDate)) {
        div.classList.add("selected");
      }

      const key = formatDateKey(date);
      const events = eventsByDate[key] || [];
      const total = events.reduce((sum, e) => sum + Number(e.value || 0), 0);

      const num = document.createElement("div");
      num.className = "calendar-day-number";
      if (datesEqual(date, today)) {
        num.classList.add("today");
      }
      num.textContent = date.getDate();
      div.appendChild(num);

      // show up to 2 event pills compact
      const shown = events.slice(0, 2);
      for (const ev of shown) {
        const pill = document.createElement("div");
        pill.className = "pill-compact";
        pill.style.backgroundColor = ev.color || "#36cfc9";

        const dot = document.createElement("span");
        dot.className = "pill-dot";
        pill.appendChild(dot);

        const span = document.createElement("span");
        span.textContent = ev.name;
        pill.appendChild(span);

        div.appendChild(pill);
      }
      if (events.length > 2) {
        const more = document.createElement("div");
        more.className = "pill-compact";
        more.style.backgroundColor = "transparent";
        more.style.border = "1px dashed rgba(160,173,184,0.4)";
        more.style.color = "#a0adb8";
        more.innerHTML = `+${events.length - 2} more`;
        div.appendChild(more);
      }

      if (events.length > 0) {
        const totalDiv = document.createElement("div");
        totalDiv.className = "day-total";
        totalDiv.textContent = total.toFixed(0);
        div.appendChild(totalDiv);
      }

      if (!div.classList.contains("disabled-range")) {
        div.addEventListener("click", () => {
          selectedDate = date;
          renderCalendar();
          renderDayDetails();
        });
      }

      return div;
    }

    function updateMonthNavButtons() {
      const prevBtn = $("prevMonthBtn");
      const nextBtn = $("nextMonthBtn");

      const prevMonth = new Date(
        currentMonth.getFullYear(),
        currentMonth.getMonth() - 1,
        1
      );
      const nextMonth = new Date(
        currentMonth.getFullYear(),
        currentMonth.getMonth() + 1,
        1
      );

      // month is in range if at least one day in that month is within [RANGE_START, RANGE_END]
      const prevEnd = new Date(
        prevMonth.getFullYear(),
        prevMonth.getMonth() + 1,
        0
      );
      const nextEnd = new Date(
        nextMonth.getFullYear(),
        nextMonth.getMonth() + 1,
        0
      );

      prevBtn.disabled = prevEnd < RANGE_START;
      nextBtn.disabled = nextMonth > RANGE_END;
    }

    /******** DAY DETAILS RENDERING ********/

    function renderDayDetails() {
      $("limitAmount").textContent = DAILY_LIMIT.toFixed(0);

      const key = formatDateKey(selectedDate);
      const events = eventsByDate[key] || [];

      $("summaryTitle").textContent = `Day: ${key}`;
      $("summarySubtitle").textContent = `Events for ${key}`;

      const totalUsed = events.reduce((sum, e) => sum + Number(e.value || 0), 0);
      $("usedAmount").textContent = totalUsed.toFixed(0);

      const remaining = DAILY_LIMIT - totalUsed;
      const remainingEl = $("remainingAmount");
      remainingEl.textContent = remaining.toFixed(0);
      remainingEl.className =
        "limit-highlight" + (remaining < 0 ? " limit-over" : "");

      const overFlag = $("overFlag");
      overFlag.textContent = remaining < 0 ? "Over limit!" : "";

      const list = $("eventList");
      list.innerHTML = "";

      if (events.length === 0) {
        $("emptyState").style.display = "block";
      } else {
        $("emptyState").style.display = "none";
        for (const ev of events) {
          const pill = document.createElement("div");
          pill.className = "event-pill";
          pill.style.backgroundColor = ev.color || "#36cfc9";
          if (ev.done) pill.classList.add("done");

          pill.addEventListener("click", (e) => {
            // clicking the checkbox should not open edit
            if (e.target.classList.contains("pill-checkbox")) return;
            openEditModal(ev);
          });

          const checkbox = document.createElement("div");
          checkbox.className = "pill-checkbox";
          checkbox.textContent = ev.done ? "âœ“" : "";
          checkbox.addEventListener("click", async (e) => {
            e.stopPropagation();
            await toggleDone(ev);
          });
          pill.appendChild(checkbox);

          const nameSpan = document.createElement("span");
          nameSpan.className = "event-name";
          nameSpan.textContent = ev.name;
          pill.appendChild(nameSpan);

          const valueSpan = document.createElement("span");
          valueSpan.className = "event-value";
          valueSpan.textContent = Number(ev.value || 0).toFixed(0);
          pill.appendChild(valueSpan);

          list.appendChild(pill);
        }
      }
    }

    /******** API: FETCH & MUTATE EVENTS ********/

    async function refreshEventsForMonth() {
      if (!currentUser) return;

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      const from = new Date(year, month, 1);
      const to = new Date(year, month + 1, 0);

      // clamp to range
      const fromKey = formatDateKey(
        from < RANGE_START ? RANGE_START : from
      );
      const toKey = formatDateKey(to > RANGE_END ? RANGE_END : to);

      const { data, error } = await supabase
        .from("events")
        .select("*")
        .gte("event_date", fromKey)
        .lte("event_date", toKey)
        .order("event_date", { ascending: true })
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Error fetching events:", error);
        return;
      }

      eventsByDate = {};
      for (const ev of data) {
        const key = ev.event_date;
        if (!eventsByDate[key]) eventsByDate[key] = [];
        eventsByDate[key].push(ev);
      }

      renderCalendar();
      renderDayDetails();
    }

    async function addEvent() {
      if (!currentUser) return;

      const name = $("newName").value.trim();
      const valueRaw = $("newValue").value;
      const color = $("newColor").value || "#36cfc9";

      if (!name || !valueRaw) {
        alert("Name and value are required.");
        return;
      }

      const value = Number(valueRaw);
      if (isNaN(value)) {
        alert("Value must be a number.");
        return;
      }

      const dateKey = formatDateKey(selectedDate);
      const nameNormalized = name.toLowerCase();

      const { data, error } = await supabase
        .from("events")
        .insert([
          {
            event_date: dateKey,
            name,
            name_normalized: nameNormalized,
            value,
            color,
            done: false
          }
        ])
        .select()
        .single();

      if (error) {
        console.error("Error adding event:", error);
        alert("Error adding event: " + error.message);
        return;
      }

      if (!eventsByDate[dateKey]) eventsByDate[dateKey] = [];
      eventsByDate[dateKey].push(data);

      $("newName").value = "";
      $("newValue").value = "";

      renderCalendar();
      renderDayDetails();
    }

    async function toggleDone(ev) {
      const { data, error } = await supabase
        .from("events")
        .update({ done: !ev.done })
        .eq("id", ev.id)
        .select()
        .single();

      if (error) {
        console.error("Error updating done:", error);
        alert("Error updating event.");
        return;
      }

      // update local
      const dateKey = ev.event_date;
      const list = eventsByDate[dateKey] || [];
      const idx = list.findIndex((e) => e.id === ev.id);
      if (idx !== -1) list[idx] = data;

      renderCalendar();
      renderDayDetails();
    }

    async function updateEventAndColor(evId, oldNameNorm, updates) {
      const { name, value, color } = updates;
      const nameNormalized = name.toLowerCase();

      // 1. Update the single event (name, value, color, name_normalized)
      const { data: updatedEvent, error: updateError } = await supabase
        .from("events")
        .update({
          name,
          name_normalized: nameNormalized,
          value,
          color
        })
        .eq("id", evId)
        .select()
        .single();

      if (updateError) {
        return { error: updateError };
      }

      // 2. Update color for all events with this (new) normalized name
      const { error: bulkError } = await supabase
        .from("events")
        .update({ color })
        .eq("name_normalized", nameNormalized);

      if (bulkError) {
        return { error: bulkError };
      }

      // 3. Refresh month data from the server to ensure consistency
      await refreshEventsForMonth();

      return { data: updatedEvent };
    }

    async function deleteEvent(ev) {
      const { error } = await supabase.from("events").delete().eq("id", ev.id);
      if (error) {
        console.error("Error deleting event:", error);
        alert("Error deleting event.");
        return;
      }

      const dateKey = ev.event_date;
      const list = eventsByDate[dateKey] || [];
      eventsByDate[dateKey] = list.filter((e) => e.id !== ev.id);

      renderCalendar();
      renderDayDetails();
    }

    /******** EDIT MODAL ********/

    function openEditModal(ev) {
      editingEvent = ev;
      $("editName").value = ev.name;
      $("editValue").value = Number(ev.value || 0);
      $("editColor").value = ev.color || "#36cfc9";
      $("editError").textContent = "";
      $("editModalBackdrop").classList.add("show");
    }

    function closeEditModal() {
      editingEvent = null;
      $("editModalBackdrop").classList.remove("show");
    }

    async function saveEdit() {
      if (!editingEvent) return;

      const name = $("editName").value.trim();
      const valueRaw = $("editValue").value;
      const color = $("editColor").value;

      if (!name || !valueRaw) {
        $("editError").textContent = "Name and value are required.";
        return;
      }

      const value = Number(valueRaw);
      if (isNaN(value)) {
        $("editError").textContent = "Value must be a number.";
        return;
      }

      $("editError").textContent = "";

      const { error } = await updateEventAndColor(
        editingEvent.id,
        editingEvent.name_normalized,
        { name, value, color }
      );

      if (error) {
        console.error("Error updating event:", error);
        $("editError").textContent = error.message;
        return;
      }

      closeEditModal();
      // refreshEventsForMonth already called in updateEventAndColor
      renderCalendar();
      renderDayDetails();
    }

    async function handleDeleteFromModal() {
      if (!editingEvent) return;
      if (!confirm("Delete this event?")) return;
      await deleteEvent(editingEvent);
      closeEditModal();
    }

    /******** EVENT LISTENERS ********/

    function initListeners() {
      $("loginButton").addEventListener("click", login);

      $("authPassword").addEventListener("keypress", (e) => {
        if (e.key === "Enter") login();
      });

      $("prevMonthBtn").addEventListener("click", async () => {
        const newMonth = new Date(
          currentMonth.getFullYear(),
          currentMonth.getMonth() - 1,
          1
        );
        currentMonth = newMonth;
        // adjust selectedDate to stay in this month (same day if possible)
        selectedDate = new Date(
          newMonth.getFullYear(),
          newMonth.getMonth(),
          Math.min(selectedDate.getDate(), 28)
        );
        await refreshEventsForMonth();
      });

      $("nextMonthBtn").addEventListener("click", async () => {
        const newMonth = new Date(
          currentMonth.getFullYear(),
          currentMonth.getMonth() + 1,
          1
        );
        currentMonth = newMonth;
        selectedDate = new Date(
          newMonth.getFullYear(),
          newMonth.getMonth(),
          Math.min(selectedDate.getDate(), 28)
        );
        await refreshEventsForMonth();
      });

      $("addEventBtn").addEventListener("click", addEvent);

      // Edit modal
      $("editModalClose").addEventListener("click", closeEditModal);
      $("editCancelBtn").addEventListener("click", closeEditModal);
      $("editSaveBtn").addEventListener("click", saveEdit);
      $("deleteEventBtn").addEventListener("click", handleDeleteFromModal);

      $("editModalBackdrop").addEventListener("click", (e) => {
        if (e.target === $("editModalBackdrop")) {
          closeEditModal();
        }
      });
    }

    /******** INIT ********/

    (async function init() {
      initListeners();
      $("limitAmount").textContent = DAILY_LIMIT.toFixed(0);
      renderCalendar();
      renderDayDetails();
      await checkSession();

      // Listen for auth changes
      supabase.auth.onAuthStateChange((_event, session) => {
        currentUser = session ? session.user : null;
        updateAuthUI();
        if (currentUser) {
          refreshEventsForMonth();
        } else {
          eventsByDate = {};
        }
      });
    })();
  </script>
</body>
</html>
